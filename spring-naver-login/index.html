<!DOCTYPE html>
<html lang="en">
    <head>
        
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B59ZZ06V75"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-B59ZZ06V75', { 'anonymize_ip': true });
}
</script>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>SpringFramework Naver Login 구현하기 - h3yon blog</title><meta name="Description" content="Welcome to h3yon 개구리 블로그"><meta property="og:title" content="SpringFramework Naver Login 구현하기" />
<meta property="og:description" content="스프링부트 Naver Login 구현하기 출처:
 이동욱 님의 스프링 부트와 AWS로 혼자 구현하는 웹 서비스 스프링 부트와 OAuth2 Naver   사용한 방식 저번에 카카오 로그인을 구현하였을 때는 restTemplate을 사용했었다. 그런데 이번에는 spring-security-oauth2 부분을 알아보고 사용해보고자 했다.
라이브러리 중에 spring-security-auth2-autoconfigure이 있는데, 스프링부트2에서 기존 설정을 그대로 사용할 수 있어 많은 개발자가 이 방식을 사용했다고 한다.
하지만 책에서는 spring-boot-starter-oauth2-client 라이브러리를 사용했다. 그 이유는 아래와 같다.
 스프링 팀에서 신규 기능은 oauth2 라이브러리에서만 지원하겠다고 선언 스프링부트용 라이브러리가 출시 기존에 사용되던 방식은 확장 포인트가 적절하게 open되어 있지 않아 직접 상속하거나, 오버라이딩 해야하고, 신규 라이브러리의 경우 확장 포인트를 고려해서 설계된 상태  직접 구현할 때 관련 자료를 찾아보면," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://h3yon.github.io/spring-naver-login/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-14T23:47:34+09:00" />
<meta property="article:modified_time" content="2021-08-14T23:47:34+09:00" /><meta property="og:site_name" content="h3yon site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SpringFramework Naver Login 구현하기"/>
<meta name="twitter:description" content="스프링부트 Naver Login 구현하기 출처:
 이동욱 님의 스프링 부트와 AWS로 혼자 구현하는 웹 서비스 스프링 부트와 OAuth2 Naver   사용한 방식 저번에 카카오 로그인을 구현하였을 때는 restTemplate을 사용했었다. 그런데 이번에는 spring-security-oauth2 부분을 알아보고 사용해보고자 했다.
라이브러리 중에 spring-security-auth2-autoconfigure이 있는데, 스프링부트2에서 기존 설정을 그대로 사용할 수 있어 많은 개발자가 이 방식을 사용했다고 한다.
하지만 책에서는 spring-boot-starter-oauth2-client 라이브러리를 사용했다. 그 이유는 아래와 같다.
 스프링 팀에서 신규 기능은 oauth2 라이브러리에서만 지원하겠다고 선언 스프링부트용 라이브러리가 출시 기존에 사용되던 방식은 확장 포인트가 적절하게 open되어 있지 않아 직접 상속하거나, 오버라이딩 해야하고, 신규 라이브러리의 경우 확장 포인트를 고려해서 설계된 상태  직접 구현할 때 관련 자료를 찾아보면,"/>
<meta name="application-name" content="h3yon site">
<meta name="apple-mobile-web-app-title" content="h3yon site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://h3yon.github.io/spring-naver-login/" /><link rel="prev" href="https://h3yon.github.io/nodejs-sequelize/" /><link rel="next" href="https://h3yon.github.io/h2-error/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SpringFramework Naver Login 구현하기",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/h3yon.github.io\/spring-naver-login\/"
        },"genre": "posts","keywords": "spring, oauth","wordcount":  1302 ,
        "url": "https:\/\/h3yon.github.io\/spring-naver-login\/","datePublished": "2021-08-14T23:47:34+09:00","dateModified": "2021-08-14T23:47:34+09:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "h3yon"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="h3yon blog">h3yon site</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="h3yon blog">h3yon site</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SpringFramework Naver Login 구현하기</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/h3yon" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>h3yon</a>
</span>&nbsp;<span class="post-category">included in <a href="/categories/spring/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>spring</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-08-14">2021-08-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1302 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;7 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#스프링부트-naver-login-구현하기">스프링부트 Naver Login 구현하기</a></li>
    <li><a href="#사용한-방식">사용한 방식</a></li>
    <li><a href="#의문점-해결하기">의문점 해결하기</a></li>
    <li><a href="#실습-시작">실습 시작!</a></li>
    <li><a href="#securityconfig">SecurityConfig</a></li>
    <li><a href="#resourcesapplication-oauthyml">resources/application-oauth.yml</a></li>
    <li><a href="#userentity">user/entity</a></li>
    <li><a href="#userrepositoryuserrepository">user/repository/UserRepository</a></li>
    <li><a href="#configauthcustomoauth2userservice">config/auth/CustomOAuth2UserService</a></li>
    <li><a href="#configauthdtooauthattributes">config/auth/dto/OAuthAttributes</a></li>
    <li><a href="#configauthdtosessionuser">config/auth/dto/SessionUser</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="스프링부트-naver-login-구현하기">스프링부트 Naver Login 구현하기</h2>
<p>출처:</p>
<ul>
<li>이동욱 님의 스프링 부트와 AWS로 혼자 구현하는 웹 서비스</li>
<li><a href="https://velog.io/@guswns3371/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8%EC%99%80-OAuth2-Naver" target="_blank" rel="noopener noreffer">스프링 부트와 OAuth2 Naver</a>
</li>
</ul>
<h2 id="사용한-방식">사용한 방식</h2>
<p>저번에 카카오 로그인을 구현하였을 때는 restTemplate을 사용했었다.
그런데 이번에는 <code>spring-security-oauth2</code> 부분을 알아보고 사용해보고자 했다.</p>
<p>라이브러리 중에 <code>spring-security-auth2-autoconfigure</code>이 있는데,
스프링부트2에서 기존 설정을 그대로 사용할 수 있어 많은 개발자가 이 방식을 사용했다고 한다.</p>
<p>하지만 책에서는 <code>spring-boot-starter-oauth2-client</code> 라이브러리를 사용했다.
그 이유는 아래와 같다.</p>
<ul>
<li>스프링 팀에서 신규 기능은 oauth2 라이브러리에서만 지원하겠다고 선언</li>
<li>스프링부트용 라이브러리가 출시</li>
<li>기존에 사용되던 방식은 확장 포인트가 적절하게 open되어 있지 않아 직접 상속하거나,
오버라이딩 해야하고, 신규 라이브러리의 경우 확장 포인트를 고려해서 설계된 상태</li>
</ul>
<p>직접 구현할 때 관련 자료를 찾아보면,</p>
<ol>
<li>application.properties 혹은 application.yml</li>
<li>spring-security-oauth2-autoconfigure 라이브러리를 사용했는지
에 대한 의문을 가질 수 있다.</li>
</ol>
<h2 id="의문점-해결하기">의문점 해결하기</h2>
<ol>
<li>
<p>application.properties 혹은 application.yml</p>
<h5>1) application.properties </h5>
application.properties의 구조는 아래와 같다.
spring 안에 datasource가 있을 경우 '.'을 사용하여 계층적 데이터를 표시함을 알 수 있다.
또, 아래처럼 '#---'을 사용하여 여러 문서로 분할할 수 있다.
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#---
</span></span><span class="line"><span class="cl">spring.config.activate.on-profile=dev
</span></span><span class="line"><span class="cl">spring.datasource.password=password
</span></span><span class="line"><span class="cl">#---
</span></span><span class="line"><span class="cl">spring.config.activate.on-profile=prod
</span></span><span class="line"><span class="cl">spring.datasource.password=password
</span></span></code></pre></td></tr></table>
</div>
</div><h5>2) application.yml </h5>
<p>application.yml에서는 계층 구조가 아래처럼 나타남을 알 수 있고,
&lsquo;&mdash;&lsquo;을 사용하여 여러 문서 파일을 지원함을 알 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">   datasource:
</span></span><span class="line"><span class="cl">      password: password
</span></span><span class="line"><span class="cl">      url: jdbc:h2:dev
</span></span><span class="line"><span class="cl">      username: SA
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">      config:
</span></span><span class="line"><span class="cl">         activate:
</span></span><span class="line"><span class="cl">            on-profile: staging
</span></span><span class="line"><span class="cl">      datasource:
</span></span><span class="line"><span class="cl">         password: &#39;password&#39;
</span></span><span class="line"><span class="cl">         url: jdbc:h2:staging
</span></span><span class="line"><span class="cl">         username: SA
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>application.yml의 이점</p>
<p>둘이 어떤 케이스에 각각 사용되는지가 제일 궁금해서 검색을 해보았는데,
그 내용은 아래와 같다.</p>
<ul>
<li>application.yml 파일이 각종 설정값을 관리하는데 더 편하고,
YAML은 JSON의 확장판과 같기 때문에 가독성 측면에서 좋다</li>
<li>properties 파일을 많이 사용하였지만 표현의 한계로 yaml 파일을 더 많이 사용하게 되었다.</li>
</ul>
<p>위의 이유로 yml 파일을 주로 사용함을 알 수 있다.</p>
</li>
</ul>
</li>
</ol>
<h2 id="실습-시작">실습 시작!</h2>
<p>우선 build.gradle로 가서 의존성 하나를 추가해준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># build.gradle
</span></span><span class="line"><span class="cl">implementation &#39;org.springframework.boot:spring-boot-starter-oauth2-client&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>해당 의존성은 소셜 로그인 등 클라이언트 입장에서 소셜 기능 구현 시 필요한 의존성
그럼 소셜 로그인 코드를 작성하기 앞서,</p>
<p><code>config/auth</code>패키지를 생성해준다.</p>
<h2 id="securityconfig">SecurityConfig</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@RequiredArgsConstructor
</span></span><span class="line"><span class="cl">@EnableWebSecurity
</span></span><span class="line"><span class="cl">public class SecurityConfig extends WebSecurityConfigurerAdapter {
</span></span><span class="line"><span class="cl">    private final CustomOAuth2UserService customOAuth2UserService;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @Override
</span></span><span class="line"><span class="cl">    protected void configure(HttpSecurity http) throws Exception{
</span></span><span class="line"><span class="cl">        http
</span></span><span class="line"><span class="cl">                .csrf().disable().headers().frameOptions().disable().and()
</span></span><span class="line"><span class="cl">                .authorizeRequests()
</span></span><span class="line"><span class="cl">                .andMatchers(&#34;/&#34;,&#34;/css/**&#34;,&#34;/images/**&#34;,&#34;/js/**&#34;,&#34;/h2-console/**&#34;, &#34;/profile&#34;).permitAll()
</span></span><span class="line"><span class="cl">                .andMatchers(&#34;/api/v1/**&#34;).hasRole(Role.USER.name())
</span></span><span class="line"><span class="cl">                .anyRequest().authenticated()
</span></span><span class="line"><span class="cl">                .and()
</span></span><span class="line"><span class="cl">                .logout()
</span></span><span class="line"><span class="cl">                .logoutSuccessUrl(&#34;/&#34;)
</span></span><span class="line"><span class="cl">                .and()
</span></span><span class="line"><span class="cl">                .oauth2Login()
</span></span><span class="line"><span class="cl">                .userInfoEndpoint()
</span></span><span class="line"><span class="cl">                .userService(customOAuth2UserService);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>@EnableWebSecurity:
Spring Security 설정들을 활성화시켜줍니다.</li>
<li>.csrf().disable().headers().frameOptions().disable().and():
h2-console 화면을 사용하기 위해 해당 옵션들을 disable하는 부분</li>
<li>.authorizeRequests():
URL 별 권한 관리를 설정하는 옵션의 시작점
이 부분을 넣어주어야 andMatchers() 옵션 사용 가능</li>
<li>.andMatchers(&quot;/&quot;,&quot;/css/**&quot;, &hellip;).permitAll():
matchers 안에 있는 &ldquo;/&rdquo; 같은 부분들은 permitAll() 옵션으로 전체 열람 권한 줄 수 O</li>
<li>anyRequest().authenticated():
설정된 값 이외 나머지 URL은 인증된 사용자들에게만 허용</li>
<li>.logout().logoutSuccessUrl(&quot;/&quot;)
로그아웃 기능에 대한 여러 설정의 진입점</li>
<li>.oauth2Login()
oauth2 로그인 기능에 대한 여러 설정 진입점</li>
<li>.userInfoEndPoint()
oAuth2 로그인 성공 이후 사용자 정보를 가져올 때의 설정 담당</li>
<li>.userService
소셜 로그인 성공 시 후속 조치 진행. 추가로 진행하고자 하는 기능 명시 가능
<blockquote>
<p>OAuth2UserService 인터페이스의 추상메서드인 loadUser를 사용</p>
</blockquote>
</li>
</ul>
<h2 id="resourcesapplication-oauthyml">resources/application-oauth.yml</h2>
<p>resources에 application.yml 파일이 있을텐데,
resources/application-oauth.yml 파일 또한 만들어준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># resources/application-oauth.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">  security:
</span></span><span class="line"><span class="cl">    oauth2:
</span></span><span class="line"><span class="cl">      client:
</span></span><span class="line"><span class="cl">        registration:
</span></span><span class="line"><span class="cl">          naver:
</span></span><span class="line"><span class="cl">            client-id: l4Z5n7Dr8puo1xal22dq
</span></span><span class="line"><span class="cl">            client-secret: fpoi6aZ8SO
</span></span><span class="line"><span class="cl">            redirect-uri: &#34;{baseUrl}/{action}/oauth2/code/{registrationId}&#34;
</span></span><span class="line"><span class="cl">            authorization-grant-type: authorization_code
</span></span><span class="line"><span class="cl">            scope: name,email,profile_image
</span></span><span class="line"><span class="cl">            client-name: Naver
</span></span><span class="line"><span class="cl">        provider:
</span></span><span class="line"><span class="cl">          naver:
</span></span><span class="line"><span class="cl">            authorization-uri: https://nid.naver.com/oauth2.0/authorize
</span></span><span class="line"><span class="cl">            token-uri: https://nid.naver.com/oauth2.0/token
</span></span><span class="line"><span class="cl">            user-info-uri: https://openapi.naver.com/v1/nid/me
</span></span><span class="line"><span class="cl">            user-name-attribute: response
</span></span></code></pre></td></tr></table>
</div>
</div><p>네이버는 Spring Security를 공식 지원하지 않기 때문에,
위에처럼 provider 값들을 수동으로 입력한다.
그래서 예를 들어 http://localhost:8080/oauth2/authorization/naver URL 값을 넣어주면</p>
<p>그럼 해당 oauth.yml 파일을 사용할 것이기 때문에
아래 profiles 부분을 spring 아래 아무데에나 넣어준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># resources/application.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">spring:
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">profiles:
</span></span><span class="line"><span class="cl">include: oauth
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="userentity">user/entity</h2>
<p>아래처럼 userEntity가 있다고 가정한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * user/entity/User.java
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="nd">@NoArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Entity</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="n">BaseTimeEntity</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Id</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Enumerated: Enum 값을 어떤 형태로 저장할지에 대한 설정(Default = INT)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Enumerated</span><span class="o">(</span><span class="n">EnumType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Role</span> <span class="n">role</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Builder</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">picture</span><span class="o">,</span> <span class="n">Role</span> <span class="n">role</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">picture</span> <span class="o">=</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">role</span> <span class="o">=</span> <span class="n">role</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">User</span> <span class="nf">update</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">picture</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">picture</span> <span class="o">=</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getRoleKey</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">role</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>위에서 Role을 넣어주었기 때문에
Role.java 파일을 만들어준다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * user/entity/Role을.java
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">Role</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GUEST</span><span class="o">(</span><span class="s">&#34;ROLE_GUEST&#34;</span><span class="o">,</span> <span class="s">&#34;손님&#34;</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">USER</span><span class="o">(</span><span class="s">&#34;ROLE_USER&#34;</span><span class="o">,</span> <span class="s">&#34;일반 사용자&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>스프링 security에서는 권한 코드에 항상 &lsquo;ROLE_&lsquo;이 앞에 있어야 한다.</p>
<h2 id="userrepositoryuserrepository">user/repository/UserRepository</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * user/repository/UserRepository.java
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>원하는 걸 사용할 수 있는데,
책의 예제에서는 findByEmail을 하였음을 알 수 있다.</p>
<h2 id="configauthcustomoauth2userservice">config/auth/CustomOAuth2UserService</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * config/auth/CustomOAuth2UserService.java
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@RequiredArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomOAuth2UserService</span> <span class="kd">implements</span> <span class="n">OAuth2UserService</span><span class="o">&lt;</span><span class="n">OAuth2UserRequest</span><span class="o">,</span> <span class="n">OAuth2User</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HttpSession</span> <span class="n">httpSession</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">OAuth2User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="n">OAuth2UserRequest</span> <span class="n">userRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">OAuth2AuthenticationException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * DefaultOAuth2UserService는 OAuth2UserService의 구현체
</span></span></span><span class="line"><span class="cl"><span class="cm">        * - 해당 클래스를 이용해서 userRequest에 있는 정보를 빼낼 수 있습니다.
</span></span></span><span class="line"><span class="cl"><span class="cm">        * - objectMapper를 이용해서 json 형식으로 출력 가능(new ObjectMapper().writerWithDefaultPrettyPrinter().writeValueAsString(userRequest))
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="n">OAuth2UserService</span> <span class="n">delegate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultOAuth2UserService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">OAuth2User</span> <span class="n">oAuth2User</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">loadUser</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 변수에 대한 설명
</span></span></span><span class="line"><span class="cl"><span class="cm">         * registrationId: 로그인 진행중인 서비스를 구분하는 코드 (구글, 네이버)
</span></span></span><span class="line"><span class="cl"><span class="cm">         * userNameAttributeName: OAuth2 로그인 진행시 키가 되는 필드값 (PK 같은 역할) - 구글은 제공하지만 네이버, 카카오는 제공 X
</span></span></span><span class="line"><span class="cl"><span class="cm">         * attributes: OAuth2UserService 를 통해 가져온 OAuth2User 클래스의 attribute를 담을 클래스
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - oAuth2User: OAuth2UserService 로 만들어진 OAuth2User 객체를 참조하는 변수
</span></span></span><span class="line"><span class="cl"><span class="cm">         * - custom 정의 클래스
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">registrationId</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getRegistrationId</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">userNameAttributeName</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">getClientRegistration</span><span class="o">().</span><span class="na">getProviderDetails</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">getUserInfoEndpoint</span><span class="o">().</span><span class="na">getUserNameAttributeName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">OAuthAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">OAuthAttributes</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">registrationId</span><span class="o">,</span> <span class="n">userNameAttributeName</span><span class="o">,</span> <span class="n">oAuth2User</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">saveOrUpdate</span><span class="o">(</span><span class="n">attributes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 세션에 자용자 정보를 저장하기 위한 DTO 클래스. User 클래스를 사용하면 안되기에 SessionUser
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 왜 사용하면 안 될까?? 직렬화 관련 에러 + User 클래스가 데이터베이스와 직접 연결되는 엔티티여서
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 렬화 기능을 가진 DTO를 하나 추가로 만드는 것이 이후 운영 및 유지보수 때 많은 도움
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">httpSession</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">&#34;user&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SessionUser</span><span class="o">(</span><span class="n">user</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DefaultOAuth2User</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singleton</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRoleKey</span><span class="o">())),</span>
</span></span><span class="line"><span class="cl">                <span class="n">attributes</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">attributes</span><span class="o">.</span><span class="na">getNameAttributeKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">User</span> <span class="nf">saveOrUpdate</span><span class="o">(</span><span class="n">OAuthAttributes</span> <span class="n">attributes</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmail</span><span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">getEmail</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">entity</span> <span class="o">-&gt;</span> <span class="n">entity</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getPicture</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">toEntity</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>RequiredArgsConstructor: 초기화 되지않은 final 필드나, @NonNull 이 붙은 필드에 대해 생성자를 생성</li>
<li>&lsquo;CustomOAuth2UserService 클래스까지 생성되었다면 OAuthAttributes 클래스를 생성</li>
</ul>
<h2 id="configauthdtooauthattributes">config/auth/dto/OAuthAttributes</h2>
<p>OAuthAttributes를 봐보자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OAuthAttributes</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">nameAttributeKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Builder</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">OAuthAttributes</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">String</span> <span class="n">nameAttributeKey</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">picture</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">nameAttributeKey</span> <span class="o">=</span> <span class="n">nameAttributeKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">picture</span> <span class="o">=</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* OAuth2User에서 반환하는 사용자 정보는 Map 자료구조 형태이기에 값 하나하나를 변환 */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">OAuthAttributes</span> <span class="nf">of</span><span class="o">(</span><span class="n">String</span> <span class="n">registrationId</span><span class="o">,</span> <span class="n">String</span> <span class="n">userNameAttributeName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span> <span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ofNaver</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">OAuthAttributes</span> <span class="nf">ofNaver</span><span class="o">(</span><span class="n">String</span> <span class="n">userNameAttributeName</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;)</span> <span class="n">attributes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;response&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">OAuthAttributes</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">name</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">email</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;email&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">picture</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;profile_image&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">attributes</span><span class="o">(</span><span class="n">response</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">nameAttributeKey</span><span class="o">(</span><span class="n">userNameAttributeName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 가입 기본 권한: GUEST. User 엔티티 생성 */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">User</span> <span class="nf">toEntity</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="n">email</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">picture</span><span class="o">(</span><span class="n">picture</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">role</span><span class="o">(</span><span class="n">Role</span><span class="o">.</span><span class="na">GUEST</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="configauthdtosessionuser">config/auth/dto/SessionUser</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionUser</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">picture</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">SessionUser</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">picture</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getPicture</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>인증된 사용자 정보만 필요합니다.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-08-14</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/spring-naver-login/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://h3yon.github.io/spring-naver-login/" data-title="SpringFramework Naver Login 구현하기" data-hashtags="spring,oauth"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://h3yon.github.io/spring-naver-login/" data-hashtag="spring"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://h3yon.github.io/spring-naver-login/" data-title="SpringFramework Naver Login 구현하기"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://h3yon.github.io/spring-naver-login/" data-title="SpringFramework Naver Login 구현하기"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://h3yon.github.io/spring-naver-login/" data-title="SpringFramework Naver Login 구현하기"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/spring/">spring</a>,&nbsp;<a href="/tags/oauth/">oauth</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/nodejs-sequelize/" class="prev" rel="prev" title="Node.js의 ORM, sequelize"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Node.js의 ORM, sequelize</a>
            <a href="/h2-error/" class="next" rel="next" title="h2 database 에러 해결하기">h2 database 에러 해결하기<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/h3yon" target="_blank">h3yon</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/plugins/parent-fit/ls.parent-fit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
